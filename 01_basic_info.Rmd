---
title: "Basic Info"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Unit C2"
output:
  html_document: 
    toc: yes
    toc_float: yes
    fig_width:  10
    fig_height: 7
    theme: cerulean
params:
  report: LU
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r country, include=FALSE}
# country sel is specified in the UI script and taken from there
country_sel <- params$report
```

```{r load_packages, include=FALSE}
# Packages needed
library(rio)
library(tidyverse)
library(data.table)
library(dataregacc)
library(regacc)
options(dplyr.summarise.inform = FALSE)
```

```{r, data}
data<- regacc::load_xml(folder =  "data/xml",
                         country_sel = country_sel,
                         consolidate = FALSE) %>%
  arrange(date) %>%
  group_by(across(
    c(
      table_identifier,
      ref_area,
      sto,
      accounting_entry,
      activity,
      unit_measure,
      time_period
    )
  )) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  mutate(country = str_sub(ref_area, 1, 2),
         NUTS = str_length(ref_area) - 2,
         NUTS=as.factor(NUTS)) %>%
  mutate(value = str_remove_all(value, "data/xml/NAREG_")) %>% 
  as.data.table()

NUTS2021<-dataregacc::NUTS_2021 %>% 
  filter(country %in% country_sel) %>% 
  mutate(across(c(NUTS,label),as_factor)) %>% 
  mutate(country=as.character(country)) %>% 
  as.data.table()


data<- left_join(data,NUTS2021)
```

### Periods reported by table

```{r}
# show first and last year reported
temp<- unique(data[!obs_status %in% c("L","M") & !is.na(obs_value) ,.(first = min(time_period), last = max(time_period)),by =.(table_identifier,country,sto,accounting_entry,unit_measure)])%>% 
  .[,lapply(.SD, as.factor),] %>% # convert to factors for better filtering
  droplevels()

show_DT(temp)
```

### Embargo dates

```{r}
# show embargo dates
if ("embargo_date" %in% colnames(data)){
  temp<- na.omit(unique(files[,.(table_identifier,country,embargo_date)])) %>% 
    .[,lapply(.SD, as.factor),] %>% 
    droplevels() %>% 
    luispack::show_DT() }

```

### Comments

```{r}
# show comments in the files
if ("comment_ts" %in% names(df)) {
temp<-na.omit(unique(data[comment_ts!="xxx" & comment_ts!="",.(country,table_identifier,comment_ts)])) %>%   
  .[,lapply(.SD, as.factor),] %>% 
  droplevels()

if (nrow(temp) > 0)
  luispack::show_DT(temp) }
```

### Data not for publication

```{r}
# data not for publication, with a flag N
temp<-na.omit(unique(data[conf_status=="N",.(country,table_identifier,sto,activity,unit_measure,conf_status)]))%>% 
  .[,lapply(.SD, as.factor),] %>% 
  droplevels()

if (nrow(temp) > 0)
  luispack::show_DT(temp) 
 
```

### Flags

```{r}
# flags E,P,B,D,U
temp<-na.omit(unique(data[obs_status %in% c("E","P","B","D","U"),.(country,table_identifier,sto,unit_measure,obs_status,time_period)])) %>% 
  .[,lapply(.SD, as.factor),] %>% 
  droplevels()  

if (nrow(temp) > 0)
  luispack::show_DT(temp) 
```
